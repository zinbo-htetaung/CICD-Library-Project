<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Library Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/home.css" rel="stylesheet" />
</head>

<body>
    <div id="navbar-container"></div>

    <!-- Introduction Sentence Header -->
    <header class="text-center py-5 bg-light">
        <h1>Welcome to Our Library</h1>
        <p>Your gateway to a world of knowledge and adventure. Explore, request, and borrow books from our vast
            collection!</p>
    </header>

    <!-- About Us and Additional Cards Section -->
    <section class="container my-5">
        <div class="row">
            <!-- About Us Section -->
            <div class="col-md-4 mt-4">
                <div class="card shadow-lg border-light rounded">
                    <div class="card-body text-center">
                        <h2 class="card-title mb-4">About Us</h2>
                        <p class="text-muted mb-4">A community library that opens doors to knowledge, creativity, and
                            growth, for all ages and interests.</p>

                        <h4 class="mb-3">Why We're Special</h4>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-book-half me-3 fs-2 text-primary"></i>
                                    <div>
                                        <p class="text-muted mb-0">Dive into our endless digital library‚Äîfree e-books,
                                            audiobooks, and more.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-check me-3 fs-2 text-primary"></i>
                                    <div>
                                        <p class="text-muted mb-0">No membership fees‚Äîreading is for everyone,
                                            everywhere.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-recycle me-3 fs-2 text-primary"></i>
                                    <div>
                                        <p class="text-muted mb-0">We support sustainability with digital content and
                                            green community initiatives.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Library Services Section -->
            <div class="col-md-8">
                <div class="row">
                    <!-- View Books Card -->
                    <div class="col-md-4">
                        <div class="card">
                            <img src="../../images/exploreBooks.jpg" class="card-img-top" alt="View Books">
                            <div class="card-body">
                                <h5 class="card-title">Explore Our Books</h5>
                                <p class="card-text">Browse our vast collection of books across various genres. Find
                                    your next great read!</p>
                                <a href="displayAllBooks.html" class="btn btn-primary mb-2">Browse Now</a>
                            </div>
                        </div>
                    </div>

                    <!-- Request Books Card -->
                    <div class="col-md-4">
                        <div class="card">
                            <img src="../../images/requestBook.jpg" class="card-img-top" alt="Request Book">
                            <div class="card-body">
                                <h5 class="card-title">Request a Book</h5>
                                <p class="card-text">Looking for a book that isn't available? Let us know, and we'll
                                    request it for you.</p>
                                <a href="bookRequest.html" class="btn btn-primary mb-2">Request Book</a>
                            </div>
                        </div>
                    </div>

                    <!-- Return Books Card -->
                    <div class="col-md-4">
                        <div class="card">
                            <img src="../../images/returnBook.jpg" class="card-img-top" alt="Return Book">
                            <div class="card-body">
                                <h5 class="card-title">Return a Book</h5>
                                <p class="card-text">Have books to return? Drop them off at your convenience and keep
                                    the cycle going.</p>
                                <a href="rentedBooks.html" class="btn btn-primary mb-2">Return Now</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Frequently Asked Questions Section -->
    <section class="container my-5">
        <h2 class="text-center">Frequently Asked Questions</h2>
        <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="faqOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        How can I borrow books?
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="faqOne"
                    data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        You can borrow books by signing up for a membership and visiting the library or by requesting
                        books online through our platform.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="faqTwo">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                        Do you charge fees for borrowing books?
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="faqTwo"
                    data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        Borrowing books is free for all registered members. However, there may be late fees for overdue
                        books.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="faqThree">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                        How can I become a member?
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="faqThree"
                    data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        Becoming a member is easy! You can sign up through our website or by visiting the library with a
                        valid ID.
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="container my-5 email-us-section">
        <h2 class="text-center">Email Us</h2>
        <p class="text-center">Have questions or feedback? Send us an email, and we'll get back to you as soon as
            possible!</p>
        <form id="contact-form">
            <div class="mb-3">
                <input type="text" class="form-control" id="name" name="name" placeholder="Your Name" required />
            </div>
            <div class="mb-3">
                <input type="email" class="form-control" id="email" name="email" placeholder="Your Email" required />
            </div>
            <div class="mb-3">
                <textarea class="form-control" id="message" name="message" rows="5" placeholder="Your Message"
                    required></textarea>
            </div>
            <div class="col-md-3">
                <div class="g-recaptcha" data-sitekey="6LfMGboqAAAAAPXLtwKP9GUaVE9Ly2eqJKsHQLYw"></div>
            </div>
            <div id="form-message" style="min-height: 25px; margin-top: 10px; color: red; font-size: 14px;">&nbsp;</div>
            <button type="submit" class="btn btn-primary" style="margin-top: 3px;">Send Message</button>
        </form>
    </section>
    <!-- Chatbot Container -->
    <div id="chatbot-container">
        <div id="chatbot-header">
            Chat with Us
            <button class="close-btn" onclick="closeChatbot()">√ó</button> <!-- Close Button -->
        </div>
        <div id="chatbot-messages"></div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Ask me anything..." />
            <button id="chatbot-send-btn">Send</button>
        </div>
        <div id="chatbot-options"></div> <!-- Container for the response options -->
    </div>

    <!-- Chatbot Toggle Button with Notification Badge -->
    <button id="chatbot-toggle-btn" onclick="sendGreetingMessage()">
        <img src="../../images/chatbot.jpg" alt="Chatbot Icon" />
        <div id="notification-badge">1</div> <!-- Red notification badge -->
    </button>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

    <script>
        let searchInProgress = false;
        let chatbotEnabled = false;
        let hasGreeted = false;
        let liveChatActive = false;

        function sendGreetingMessage() {
            if (!hasGreeted) {
                displayMessage("Hello! How can I assist you today? üòä", "bot");
                hasGreeted = true;
            }
            displayResponseOptions();
        }

        function closeChatbot() {
            document.getElementById('chatbot-container').style.display = 'none';
        }

        document.getElementById('chatbot-send-btn').addEventListener('click', function () {
            let userInput = document.getElementById('chatbot-input').value.trim();
            if (!userInput) return;
            if (!liveChatActive) {
                displayMessage(userInput, 'user');
            }

            if (searchInProgress) {
                searchBooks(userInput);
            } else {
                let botResponse = generateBotResponse(userInput);
                setTimeout(() => {
                    displayMessage(botResponse, 'bot');
                    displayResponseOptions();
                }, 500);
            }

            document.getElementById('chatbot-input').value = '';
        });

        function displayMessage(message, sender) {
            console.log(liveChatActive);
            if (!liveChatActive) {
                let messageContainer = document.createElement('div');
                messageContainer.classList.add('message');
                messageContainer.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

                // Use innerHTML to allow HTML content (like <a> tag) to be rendered correctly
                messageContainer.innerHTML = message;

                document.getElementById('chatbot-messages').appendChild(messageContainer);
                document.getElementById('chatbot-messages').scrollTop = document.getElementById('chatbot-messages').scrollHeight;
            } else {
                let chatContainer = document.getElementById('chatbot-messages');

                // Get last message element
                let lastMessage = chatContainer.lastElementChild;

                // Prevent duplicate consecutive messages
                if (lastMessage && lastMessage.innerHTML.trim() === message.trim()) {
                    return;
                }

                let messageContainer = document.createElement('div');
                messageContainer.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
                messageContainer.innerHTML = message;
                chatContainer.appendChild(messageContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function generateBotResponse(userInput) {
            let doc = nlp(userInput.toLowerCase());
            if (liveChatActive) {
                sendMessageToAdmin(userInput);
                return null;  // üöÄ Do not respond with normal chatbot messages
            } else {

                if (doc.has('hello') || doc.has('hi') || doc.has('hey')) return "Hello! How can I assist you today? üòä";
                if (doc.has('hours') || doc.has('open') || doc.has('close')) return "We are open from 9 AM to 6 PM every day!";
                if (doc.has('books') || doc.has('collection')) return 'We have a large collection of books! <a href="displayAllBooks.html" target="_blank">Explore here.</a>';
                if (doc.has('membership') || doc.has('register')) return "Sign up for membership on our website or visit the library with an ID.";
                if (doc.has('contact') || doc.has('agent') || doc.has('help')) {
                    displayMessage("Live agent chat enabled. Connecting you to an admin...", "bot");

                    // Wait for 2-3 seconds before calling enableLiveChat
                    setTimeout(() => {
                        enableLiveChat();
                    }, Math.floor(Math.random() * 1000) + 2000);

                    return "‚è≥ Retrieving chat history..."
                }
                if (doc.has('search') && !searchInProgress) {
                    searchInProgress = true;
                    return "Please type the name of the book you're searching for.";
                }

                return "I'm not sure how to respond to that. Try asking about our opening hours, books, or membership.";
            }
        }

        async function searchBooks(bookName) {
            try {
                const response = await fetch(`/api/books/name/${bookName}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (response.status === 200) {
                    const data = await response.json();
                    if (data.books.length > 0) {
                        data.books.forEach((book, index) => {
                            let bookMessage = `üìñ (${index + 1}) ${book.book_name} by ${book.author}.  <a href="displaySingleBook.html?bookId=${book.id}" target="_blank">Click here to view details ^^</a>`;
                            displayMessage(bookMessage, 'bot');
                        });
                    } else {
                        displayMessage("‚ùå No books found. Try searching again.", 'bot');
                    }
                } else {
                    displayMessage("‚ùå No books found. Try searching again.", 'bot');
                }
            } catch (error) {
                console.error('Error searching books:', error);
                displayMessage("‚ùå Unable to search at the moment. Try again later.", 'bot');
            }
            searchInProgress = false;
        }
        async function enableLiveChat() {
            chatbotEnabled = true;
            liveChatActive = true; // Enable live chat mode

            // Simulate a 2-3 second loading delay before fetching messages
            setTimeout(async () => {
                displayMessage("‚úÖ Live chat enabled. You are now connected with an admin.", "bot");
                await startAdminChat();

                // Start fetching messages every 3 seconds
                startMessagePolling();

                // Start the session timeout countdown (3 minutes)
                startChatSessionTimer();
            }, Math.floor(Math.random() * 1000) + 2000);
        }

        async function startAdminChat() {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("user_id");

            if (!userId) {
                displayMessage("‚ö†Ô∏è Please log in to chat with an admin.", "bot");
                return;
            }

            try {
                const response = await fetch(`/api/messages/user/${userId}`, {
                    method: "GET",
                    headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
                });

                if (!response.ok) throw new Error("Failed to fetch messages");

                const messages = await response.json();
            } catch (error) {
                console.error("Error fetching messages:", error);
                displayMessage("‚ö†Ô∏è Unable to connect to admin chat. Please try again later.", "bot");
            }
        }

        async function startChatSessionTimer() {
            let remainingTime = 120; // 2 minutes (in seconds)
            let warningDisplayed = false; // Flag to track if the warning has been displayed

            // Update countdown every second
            let countdownInterval = setInterval(() => {
                remainingTime--;

                // Display a warning message when 20 seconds are left
                if (remainingTime === 20 && !warningDisplayed) {
                    displayMessage("‚ö†Ô∏è This live chat session will end in 20 seconds.", "bot");
                    warningDisplayed = true; // Ensure the message is shown only once
                }

                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    endLiveChatSession();
                }
            }, 1000);
        }

        // ‚úÖ Function to display admin & user messages properly in chatbot
        function displayAdminMessages(messages) {
            if (!messages || messages.length === 0) {
                displayMessage("No recent messages from the admin.", "bot");
                return;
            }

            // Sort messages by createdAt timestamp
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            messages.forEach(msg => {
                let senderName = msg.sender === "admin" ? "üë®‚Äçüíº Admin" : "üßë‚Äçüíª You";
                let formattedTime = formatTimestamp(msg.createdAt);

                let formattedMessage = `<strong>${senderName}</strong> <br> ${msg.message} <br><span style="font-size: 12px; color: gray;">${formattedTime}</span>`;

                // Display messages correctly in chat
                displayMessage(formattedMessage, msg.sender === "admin" ? "bot" : "user");
            });
        }

        async function sendMessageToAdmin(userInput) {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("user_id");

            if (!userId) {
                displayMessage("‚ö†Ô∏è Please log in to chat with an admin.", "bot");
                return;
            }

            try {
                const response = await fetch("/api/messages", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ userId, sender: "user", message: userInput }),
                });

                if (!response.ok) throw new Error("Message failed to send");

                // Fetch latest messages after sending
                fetchMessages(userId);
            } catch (error) {
                console.error("Error sending message:", error);
                displayMessage("‚ö†Ô∏è Failed to send message. Try again.", "bot");
            }
        }

        function endLiveChatSession() {
            chatbotEnabled = false;
            liveChatActive = false;

            // Stop polling messages
            clearInterval(pollingInterval);

            displayMessage("‚è≥ Live chat session has expired. Please press live agent to chat again.", "bot");

            setTimeout(() => {
                displayMessage("Hello! How can I assist you today? üòä", "bot");
                displayResponseOptions();
            }, 2000);
        }

        let pollingInterval; // Store the polling interval reference
        let lastMessageTimestamp = null;

        async function fetchMessages(userId) {
            const token = localStorage.getItem("token");

            try {
                const response = await fetch(`/api/messages/user/${userId}`, {
                    method: "GET",
                    headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
                });

                if (!response.ok) throw new Error("Failed to fetch messages");

                const messages = await response.json();
                if (!messages.message || messages.message.length === 0) return;

                // Filter out old messages based on the last fetched timestamp
                let newMessages = messages.message.filter(msg => {
                    let messageTime = new Date(msg.createdAt).getTime();
                    return !lastMessageTimestamp || messageTime > lastMessageTimestamp;
                });

                if (newMessages.length > 0) {
                    lastMessageTimestamp = new Date(newMessages[newMessages.length - 1].createdAt).getTime();
                    displayAdminMessages(newMessages);
                }
            } catch (error) {
                console.error("Error fetching messages:", error);
            }
        }

        // Function to start polling messages every 3 seconds
        function startMessagePolling() {
            const userId = localStorage.getItem("user_id");
            if (!userId) return;

            // Fetch messages initially
            fetchMessages(userId);

            // Poll new messages every 3 seconds (but only fetch new ones)
            pollingInterval = setInterval(() => {
                fetchMessages(userId);
            }, 3000);
        }

        // ‚úÖ Function to format timestamps into readable format (e.g., "Feb 5, 2025 - 9:01 AM")
        function formatTimestamp(timestamp) {
            let date = new Date(timestamp);
            return date.toLocaleString("en-US", {
                month: "short", day: "numeric", year: "numeric",
                hour: "numeric", minute: "2-digit", hour12: true
            });
        }

        // Function to display response options (buttons)
        function displayResponseOptions() {
            let optionsContainer = document.createElement('div');
            optionsContainer.classList.add('bot-response-options');

            const options = [
                { label: 'Library Hours', value: 'hours' },
                { label: 'Book Collection', value: 'books' },
                { label: 'Membership', value: 'membership' },
                { label: 'Contact a Live Agent', value: 'agent' },
                { label: 'Search Book', value: 'search' }
            ];

            options.forEach(option => {
                let button = document.createElement('button');
                button.textContent = option.label;
                button.onclick = function () {
                    displayMessage(option.label, 'user');
                    let botResponse = generateBotResponse(option.value);
                    setTimeout(function () {
                        displayMessage(botResponse, 'bot');
                    }, 500);
                };
                optionsContainer.appendChild(button);
            });

            document.getElementById('chatbot-options').innerHTML = ''; // Clear previous options
            document.getElementById('chatbot-options').appendChild(optionsContainer);
        }

        document.getElementById('chatbot-toggle-btn').addEventListener('click', function () {
            let chatbotContainer = document.getElementById('chatbot-container');
            chatbotContainer.style.display = chatbotContainer.style.display === "none" ? "flex" : "none";
            if (!hasGreeted) sendGreetingMessage();
        });

    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="../js/home.js" type="text/javascript"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://unpkg.com/compromise"></script>
    <script src="../js/authUser.js" type="text/javascript"></script>
    <script src="../js/notification.js"></script>

    <div id="footer-container"></div>
</body>

</html>